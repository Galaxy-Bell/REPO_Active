# REPO_Active 二次开发说明（中文）

本文档面向二次开发者，整理本项目已验证/尝试过的接口、调用方式、行为效果与常见雷点。目标是让不了解游戏内部的人也能快速接手维护。

---

## 1. 项目目标与核心思路

- **核心目标**：远程激活提取点，且保持游戏原生反馈（广播、白点标记、金额等）。
- **关键结论**：必须走 `ExtractionPoint.OnClick()` 的原生点击链路；`ButtonPress()` 在某些场景会丢失反馈或触发不完整。

---

## 2. 关键接口与调用方式（已验证）

### 2.1 ExtractionPoint.OnClick()（强烈推荐）
- **作用**：触发完整的原生点击链路（网络同步 + UI 反馈）。
- **调用方式**：反射获取 `MethodInfo`，使用 **默认参数填充** 再 `Invoke`。
- **效果**：与玩家实际点击的行为最一致（广播/白点/金额完整）。
- **注意**：可能有参数，必须用默认值填充，否则会异常。

### 2.2 UnityEngine.Object.FindObjectsOfType(Type)
- **作用**：获取场景中所有 `ExtractionPoint` 实例。
- **原因**：无需编译期依赖类型；运行时通过 Type 查找。
- **效果**：比扫描所有 `MonoBehaviour` 轻量。

### 2.3 AppDomain.CurrentDomain.GetAssemblies() + GetTypes()
- **作用**：定位 `ExtractionPoint` 类型。
- **规则**：通过 `t.Name == "ExtractionPoint"` 查找。
- **风险**：某些程序集 `GetTypes()` 抛异常，需要 try/catch。

---

## 3. 激活逻辑与排序策略

### 3.1 动态排序（已实现）
- **规则**：
  1. 记录出生点 `spawnPos`（首次获取到有效参考位置）。
  2. 选 **离出生点最近的点作为第一个激活目标**。
  3. 其余点用最近邻贪心排序，从玩家当前位置出发。
- **效果**：兼顾“第一点优先”和整体路径优化。

### 3.2 F3 逻辑（手动）
- **流程**：扫描 → 排序 → 判断阻塞 → 调用 `OnClick()` → 记录已激活。
- **注意**：阻塞条件必须严格，否则会出现自动/手动异常提交。

### 3.3 自动逻辑
- **原则**：自动逻辑 **等同于周期触发 F3**，不应写额外激活路径。
- **原因**：避免出现“自动触发与手动行为不同”的问题。

---

## 4. 发现机制（Discover）与多人支持

### 4.1 单人发现
- **方式**：本地玩家位置与提取点距离判断（20m）。
- **效果**：只要走近一次即可被标记。

### 4.2 多人发现（主机侧）
- **方式**：主机聚合所有玩家位置（PhotonView）并判定“谁靠近”。
- **原因**：客户端各自判断会导致不同步。
- **实现状态**：已通过 PhotonView 扫描获取远端玩家对象。
- **雷点**：
  - PhotonView 初期数量可能为 0；需持续扫描。
  - 需要判断哪些对象是真实玩家而非 UI/场景对象。

---

## 5. 阻塞与状态判断（重要）

### 5.1 全局阻塞条件
- **原则**：只要场上存在 **任意非 Idle/Complete 状态** 的提取点，就禁止激活新点。
- **原因**：避免“多个点并发激活”导致游戏状态错乱。

### 5.2 状态来源
- **优先**：反射字段 `currentState`。
- **兜底**：字符串包含 `Idle` / `Complete` 即视为空闲或完成。
- **雷点**：
  - 某些地图可能状态值不同，导致判断异常。
  - 无法读取 state 时会导致过度阻塞或过度放行。

---

## 6. 自动模式常见问题与解决方案

### 6.1 “未激活却显示已提交”问题
- **现象**：自动模式下，第一个点可能直接显示提交或状态异常。
- **根因**：激活时机太早，游戏尚未完全加载。
- **解决**：加入 **30 秒缓冲时间**（从进入关卡/服务准备好开始计时）。

### 6.2 重新进入关卡计时失效
- **现象**：首局正常，返回主菜单后再次进关卡异常。
- **解决**：在场景变化时重置计时器和扫描缓存。

---

## 7. 接口/方法清单（便于开发定位）

- `FindTypeByNameAcrossAssemblies("ExtractionPoint")`：定位类型。
- `FindObjectsOfType(_epType)`：扫描所有提取点。
- `InvokeOnClick(Component ep)`：反射调用 `OnClick()`。
- `BuildStage1PlannedList(...)`：动态排序逻辑。
- `IsAnyBusy()`：全局阻塞检查。
- `MarkActivated(Component ep)`：记录已激活。
- `GetReferencePos()`：获取玩家/相机坐标。

---

## 8. 已知雷点与注意事项

1. **OnClick 有参数**：必须填默认参数，直接 `Invoke(ep, null)` 可能异常。
2. **扫描过早**：场景初始化时对象尚未生成，建议延迟或持续扫描。
3. **PhotonView 混杂**：需要过滤出玩家对象，日志容易误导。
4. **多人与客户端不同步**：发现逻辑建议只在主机执行。
5. **重进关卡重置**：任何缓存（spawn、发现、激活记录、计时）必须清空。

---

## 9. 推荐调试思路

- 先确认 `ExtractionPoint.OnClick()` 是否能在手动 F3 下触发完整反馈。
- 如果自动模式异常：优先检查**计时起点**和**阻塞条件**。
- 多人问题：先验证是否能在日志中看到远端玩家的 PhotonView，再提取坐标。

---

## 10. 版本记录（简略）

- **4.5.0**：移除 F4 入口，优化 README，稳定 F3/自动逻辑。
- **4.1.x**：修复自动激活时机，加入缓冲与重置机制。

---

如果你需要更详细的网络实现（Photon/Mirror/Netcode），可以在确定游戏网络框架后补充对应 RPC/事件逻辑。
